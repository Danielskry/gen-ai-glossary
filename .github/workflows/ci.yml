name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Validate data and generated Markdown
        run: python scripts/glossary.py validate
      - name: Regenerate glossary
        run: python scripts/glossary.py generate
      - name: Fail if regenerated files differ
        run: |
          if ! git diff --quiet -- docs_src/glossary; then
            echo "::error::Glossary files are out of date. Run 'python scripts/glossary.py generate' and commit the changes." >&2
            git --no-pager diff -- docs_src/glossary | sed -n '1,200p'
            exit 1
          fi
      - name: Build GitHub Pages output
        run: python scripts/publish_docs.py
      - name: Fail if docs/ is outdated
        run: |
          if ! git diff --quiet -- docs; then
            echo "::error::Run 'python scripts/publish_docs.py' so docs/ stays in sync with the MkDocs build." >&2
            git --no-pager diff -- docs | sed -n '1,200p'
            exit 1
          fi
