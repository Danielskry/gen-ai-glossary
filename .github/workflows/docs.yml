name: Docs

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure Pages
        uses: actions/configure-pages@v5
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install docs extras
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Build
        run: mkdocs build --strict --site-dir _site
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  cleanup:
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      deployments: write
    steps:
      - name: Remove older deployments
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const environment = "github-pages";
            const deployments = await github.paginate(
              github.rest.repos.listDeployments,
              { owner, repo, environment, per_page: 100 }
            );

            if (deployments.length <= 1) {
              core.info(`Found ${deployments.length} deployment(s); nothing to remove.`);
              return;
            }

            deployments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latest = deployments.shift();
            core.info(
              `Keeping deployment ${latest.id} from ${latest.ref} (${latest.sha.slice(0, 7)})`
            );

            for (const deployment of deployments) {
              core.info(
                `Deleting deployment ${deployment.id} from ${deployment.ref} (${deployment.sha.slice(0, 7)})`
              );
              await github.rest.repos.deleteDeployment({
                owner,
                repo,
                deployment_id: deployment.id,
              });
            }
